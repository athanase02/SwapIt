<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages & Requests Test Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1117;
            color: #e4e4e7;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 20px;
            background: #1a1d27;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-section {
            background: #1a1d27;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-item {
            background: #0f1117;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #6b7280;
        }
        
        .test-item.success {
            border-left-color: #10b981;
        }
        
        .test-item.error {
            border-left-color: #ef4444;
        }
        
        .test-item.pending {
            border-left-color: #f59e0b;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #0a0c10;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        
        .success-text {
            color: #10b981;
        }
        
        .error-text {
            color: #ef4444;
        }
        
        .info-text {
            color: #60a5fa;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #4b5563;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Messages & Requests Diagnostic Tool</h1>
        <p style="color: #9ca3af; margin-bottom: 20px;">Test the fixes for messaging and requests functionality</p>
        
        <div class="status">
            <h3>Session Status: <span id="sessionStatus" class="info-text">Checking...</span></h3>
            <p id="sessionInfo" style="color: #9ca3af; margin-top: 5px;"></p>
        </div>
        
        <!-- Messages Tests -->
        <div class="test-section">
            <h2>ðŸ“¨ Messages API Tests</h2>
            
            <div class="test-item pending" id="test-conversations">
                <strong>Test 1: Get Conversations</strong>
                <p>Tests: GET ../api/messages.php?action=get_conversations</p>
                <button onclick="testGetConversations()">Run Test</button>
                <div id="result-conversations" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-item pending" id="test-unread">
                <strong>Test 2: Get Unread Count</strong>
                <p>Tests: GET ../api/messages.php?action=get_unread_count</p>
                <button onclick="testUnreadCount()">Run Test</button>
                <div id="result-unread" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-item pending" id="test-send">
                <strong>Test 3: Send Message (Requires receiver_id)</strong>
                <p>Tests: POST ../api/messages.php action=send_message</p>
                <input type="number" id="receiver-id" placeholder="Receiver User ID" style="padding: 8px; border-radius: 4px; border: 1px solid #4b5563; background: #0f1117; color: #e4e4e7; margin-right: 10px;">
                <button onclick="testSendMessage()">Run Test</button>
                <div id="result-send" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Requests Tests -->
        <div class="test-section">
            <h2>ðŸ”„ Requests API Tests</h2>
            
            <div class="test-item pending" id="test-requests">
                <strong>Test 4: Get My Requests</strong>
                <p>Tests: GET ../api/requests.php?action=get_my_requests</p>
                <button onclick="testGetRequests()">Run Test</button>
                <div id="result-requests" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-item pending" id="test-requests-sent">
                <strong>Test 5: Get Sent Requests</strong>
                <p>Tests: GET ../api/requests.php?action=get_my_requests&role=borrower</p>
                <button onclick="testGetSentRequests()">Run Test</button>
                <div id="result-requests-sent" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-item pending" id="test-requests-received">
                <strong>Test 6: Get Received Requests</strong>
                <p>Tests: GET ../api/requests.php?action=get_my_requests&role=lender</p>
                <button onclick="testGetReceivedRequests()">Run Test</button>
                <div id="result-requests-received" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Page Links -->
        <div class="test-section">
            <h2>ðŸ”— Quick Links</h2>
            <button onclick="window.location.href='pages/messages.html'" style="background: #8b5cf6;">Open Messages Page</button>
            <button onclick="window.location.href='pages/requests.html'" style="background: #8b5cf6;">Open Requests Page</button>
            <button onclick="window.location.href='pages/dashboard.html'" style="background: #6b7280;">Dashboard</button>
            <button onclick="runAllTests()" style="background: #10b981;">Run All Tests</button>
        </div>
    </div>
    
    <script>
        // Check session on load
        async function checkSession() {
            try {
                const response = await fetch('../api/auth.php?action=check_session', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    document.getElementById('sessionStatus').innerHTML = '<span class="success-text">âœ“ Authenticated</span>';
                    document.getElementById('sessionInfo').textContent = `Logged in as User ID: ${data.user.id} (${data.user.full_name || data.user.email})`;
                } else {
                    document.getElementById('sessionStatus').innerHTML = '<span class="error-text">âœ— Not Authenticated</span>';
                    document.getElementById('sessionInfo').textContent = 'Please log in to test the features';
                }
            } catch (error) {
                document.getElementById('sessionStatus').innerHTML = '<span class="error-text">âœ— Error</span>';
                document.getElementById('sessionInfo').textContent = 'Could not check session status';
            }
        }
        
        async function testGetConversations() {
            const testItem = document.getElementById('test-conversations');
            const resultDiv = document.getElementById('result-conversations');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const response = await fetch('../api/messages.php?action=get_conversations', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Found ${data.conversations ? data.conversations.length : 0} conversations<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function testUnreadCount() {
            const testItem = document.getElementById('test-unread');
            const resultDiv = document.getElementById('result-unread');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const response = await fetch('../api/messages.php?action=get_unread_count', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Unread count: ${data.unread_count}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function testSendMessage() {
            const receiverId = document.getElementById('receiver-id').value;
            if (!receiverId) {
                alert('Please enter a receiver user ID');
                return;
            }
            
            const testItem = document.getElementById('test-send');
            const resultDiv = document.getElementById('result-send');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const formData = new FormData();
                formData.append('action', 'send_message');
                formData.append('receiver_id', receiverId);
                formData.append('message', 'Test message from diagnostic tool');
                
                const response = await fetch('../api/messages.php', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Message sent!<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function testGetRequests() {
            const testItem = document.getElementById('test-requests');
            const resultDiv = document.getElementById('result-requests');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const response = await fetch('../api/requests.php?action=get_my_requests', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    
                    const requests = data.requests || [];
                    const sent = requests.filter(r => r.request_type === 'sent').length;
                    const received = requests.filter(r => r.request_type === 'received').length;
                    
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Total: ${requests.length} requests (${sent} sent, ${received} received)<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function testGetSentRequests() {
            const testItem = document.getElementById('test-requests-sent');
            const resultDiv = document.getElementById('result-requests-sent');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const response = await fetch('../api/requests.php?action=get_my_requests&role=borrower', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Found ${data.requests ? data.requests.length : 0} sent requests<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function testGetReceivedRequests() {
            const testItem = document.getElementById('test-requests-received');
            const resultDiv = document.getElementById('result-requests-received');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="spinner"></span> Testing...';
            
            try {
                const response = await fetch('../api/requests.php?action=get_my_requests&role=lender', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    testItem.classList.remove('pending');
                    testItem.classList.add('success');
                    resultDiv.innerHTML = `<span class="success-text">âœ“ Success!</span><br>Found ${data.requests ? data.requests.length : 0} received requests<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    testItem.classList.remove('pending');
                    testItem.classList.add('error');
                    resultDiv.innerHTML = `<span class="error-text">âœ— Failed</span><br>Error: ${data.error}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                testItem.classList.remove('pending');
                testItem.classList.add('error');
                resultDiv.innerHTML = `<span class="error-text">âœ— Error</span><br>${error.message}`;
            }
        }
        
        async function runAllTests() {
            await checkSession();
            await testGetConversations();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUnreadCount();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testGetRequests();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testGetSentRequests();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testGetReceivedRequests();
        }
        
        // Check session on page load
        checkSession();
    </script>
</body>
</html>
